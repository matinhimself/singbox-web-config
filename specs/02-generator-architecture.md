# Type Generator Architecture

## Purpose

The type generator automatically creates Go type definitions from the sing-box source code. This ensures our project stays synchronized with sing-box's data structures without manual maintenance.

## Source Repository

- **Repository**: https://github.com/SagerNet/sing-box
- **Branch**: `dev-next` (latest development)
- **Target Path**: `route/rule/`
- **Language**: Go

## Generator Strategy

### Phase 1: Go AST Parsing

Use Go's built-in `go/parser` and `go/ast` packages to:

1. **Clone/Fetch**: Download sing-box repository or fetch updates
2. **Parse**: Parse Go source files in `route/rule/` directory
3. **Extract**: Identify and extract relevant type definitions
4. **Transform**: Convert to our internal type system
5. **Generate**: Write Go code with our project's conventions

### Type Categories to Extract

#### 1. Rule Types
Each file in `route/rule/` typically defines a specific rule type:
- `rule_default.go` → DefaultRule
- `rule_domain.go` → DomainRule
- `rule_geoip.go` → GeoIPRule
- `rule_ipcidr.go` → IPCIDRRule
- etc.

#### 2. Struct Fields
For each type, extract:
- Field names
- Field types (string, []string, int, bool, etc.)
- JSON tags (for serialization)
- Validation tags (if present)
- Documentation comments

#### 3. Interfaces and Common Types
- Base rule interface
- Common utility types
- Enums/constants

## Generator Implementation

### File Structure

```go
internal/generator/
├── parser.go           # AST parsing logic
├── extractor.go        # Type extraction
├── transformer.go      # Type transformation
├── generator.go        # Code generation
└── repository.go       # Git operations
```

### Key Components

#### 1. Repository Manager
```go
type RepositoryManager struct {
    repoURL    string
    branch     string
    localPath  string
}

// Clone or update the sing-box repository
func (r *RepositoryManager) Update() error

// Get the path to route/rule directory
func (r *RepositoryManager) GetRulePath() string
```

#### 2. Parser
```go
type Parser struct {
    sourceDir string
}

// Parse all Go files in the directory
func (p *Parser) ParseDirectory() ([]*ast.File, error)

// Extract package information
func (p *Parser) GetPackageInfo() (*PackageInfo, error)
```

#### 3. Type Extractor
```go
type TypeExtractor struct {
    files []*ast.File
}

// Extract all rule type definitions
func (e *TypeExtractor) ExtractRuleTypes() ([]*RuleType, error)

// Extract struct fields with metadata
func (e *TypeExtractor) ExtractFields(*ast.StructType) ([]*Field, error)
```

#### 4. Code Generator
```go
type CodeGenerator struct {
    outputDir string
}

// Generate Go source files
func (g *CodeGenerator) Generate([]*RuleType) error

// Generate individual type file
func (g *CodeGenerator) GenerateType(*RuleType) error
```

### Generated Output Format

```go
// Generated by generator. DO NOT EDIT.
// Source: https://github.com/SagerNet/sing-box/tree/dev-next/route/rule
// Generated at: 2025-11-21 18:45:00

package types

// DomainRule represents a domain-based routing rule
type DomainRule struct {
    // Domain specifies domain names to match
    Domain []string `json:"domain,omitempty"`

    // DomainSuffix specifies domain suffixes to match
    DomainSuffix []string `json:"domain_suffix,omitempty"`

    // DomainKeyword specifies domain keywords to match
    DomainKeyword []string `json:"domain_keyword,omitempty"`

    // DomainRegex specifies domain regex patterns to match
    DomainRegex []string `json:"domain_regex,omitempty"`
}
```

## Generator Workflow

### Manual Execution
```bash
# Generate types from latest sing-box dev-next
go run cmd/generator/main.go

# Generate from specific branch
go run cmd/generator/main.go --branch main

# Generate from local repository
go run cmd/generator/main.go --local /path/to/sing-box
```

### Automatic Updates

Future enhancements:
1. **GitHub Actions**: Run generator on schedule (daily/weekly)
2. **Pre-commit Hook**: Verify types are up to date
3. **CI/CD Pipeline**: Auto-generate on dependency updates

## Handling Challenges

### 1. Complex Types
Some sing-box types may use interfaces, embedded structs, or generic types:
- **Solution**: Start with concrete types, add complexity incrementally
- **Fallback**: Manual type definitions for edge cases

### 2. Dependencies
Sing-box types may depend on other packages:
- **Solution**: Extract only necessary types, inline simple dependencies
- **Strategy**: Create our own simplified versions when needed

### 3. Breaking Changes
Upstream sing-box may introduce breaking changes:
- **Solution**: Version tracking, compatibility layers
- **Strategy**: Support multiple sing-box versions if needed

### 4. Documentation Extraction
Preserve comments and documentation:
- **Solution**: Extract `ast.CommentGroup` for each type/field
- **Output**: Include in generated code for better IDE support

## Validation Strategy

After generation:
1. **Syntax Check**: Generated code must compile
2. **JSON Compatibility**: Test serialization/deserialization
3. **Schema Validation**: Verify against known sing-box configs
4. **Regression Tests**: Compare with previous generation

## Metadata Tracking

Track generation metadata:
```go
type GenerationMetadata struct {
    Timestamp      time.Time
    SingBoxCommit  string
    SingBoxBranch  string
    GeneratorVersion string
    FilesProcessed int
    TypesGenerated int
}
```

Store in `internal/types/metadata.json` for traceability.

## Future Enhancements

1. **Smart Diffing**: Only regenerate changed types
2. **Custom Mappings**: Override specific types manually
3. **Extension Points**: Add custom fields/methods
4. **Multi-version Support**: Generate for multiple sing-box versions
5. **Type Documentation**: Generate markdown docs from types
