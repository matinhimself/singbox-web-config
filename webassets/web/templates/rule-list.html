{{define "rule-list.html"}}
{{if .Rules}}
<div class="rules-container" id="rules-container">
    {{range $index, $rule := .Rules}}
    <div class="rule-card" id="rule-{{$index}}" draggable="true" data-index="{{$index}}"
         ondragstart="handleDragStart(event)"
         ondragover="handleDragOver(event)"
         ondrop="handleDrop(event)"
         ondragend="handleDragEnd(event)"
         ondragenter="handleDragEnter(event)"
         ondragleave="handleDragLeave(event)">
        <div class="rule-header">
            <div style="display: flex; align-items: center;">
                <span class="drag-handle">â˜°</span>
                <span class="rule-number">#{{add $index 1}}</span>
            </div>
            <div class="rule-actions">
                <button class="button button-small button-warning"
                        hx-get="/api/rules/form?index={{$index}}"
                        hx-target="body"
                        hx-swap="beforeend">
                    Edit
                </button>
                <button class="button button-small button-danger"
                        hx-post="/api/rules/delete?index={{$index}}"
                        hx-target="#rules-list"
                        hx-swap="innerHTML"
                        hx-confirm="Are you sure you want to delete this rule?">
                    Delete
                </button>
            </div>
        </div>
        <div class="rule-content">
            <pre class="rule-json">{{marshal $rule}}</pre>
        </div>
    </div>
    {{end}}
</div>

<script>
let draggedElement = null;
let draggedIndex = null;

function handleDragStart(e) {
    draggedElement = e.target;
    draggedIndex = parseInt(e.target.dataset.index);
    e.target.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', e.target.innerHTML);
}

function handleDragOver(e) {
    if (e.preventDefault) {
        e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';
    return false;
}

function handleDragEnter(e) {
    if (e.target.classList.contains('rule-card')) {
        e.target.classList.add('drag-over');
    }
}

function handleDragLeave(e) {
    if (e.target.classList.contains('rule-card')) {
        e.target.classList.remove('drag-over');
    }
}

function handleDrop(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }
    e.preventDefault();

    const dropTarget = e.target.closest('.rule-card');
    if (draggedElement !== dropTarget && dropTarget) {
        const dropIndex = parseInt(dropTarget.dataset.index);

        // Send reorder request
        fetch('/api/rules/reorder', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `from=${draggedIndex}&to=${dropIndex}`
        })
        .then(response => {
            if (response.ok) {
                return response.text();
            }
            throw new Error('Failed to reorder');
        })
        .then(html => {
            document.getElementById('rules-list').innerHTML = html;
        })
        .catch(error => {
            console.error('Error reordering rules:', error);
            alert('Failed to reorder rules. Please try again.');
        });
    }

    dropTarget.classList.remove('drag-over');
    return false;
}

function handleDragEnd(e) {
    e.target.classList.remove('dragging');
    document.querySelectorAll('.rule-card').forEach(card => {
        card.classList.remove('drag-over');
    });
}
</script>
{{else}}
<div class="empty-state">
    <p>No rules configured yet.</p>
    <p>Click "Add Rule" to create your first routing rule.</p>
</div>
{{end}}
{{end}}
