{{define "rule-list.html"}}
{{if .Rules}}
<div class="space-y-4" id="rules-container">
    {{range $index, $rule := .Rules}}
    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm p-4 flex items-center justify-between rule-card"
         id="rule-{{$index}}" draggable="true" data-index="{{$index}}"
         ondragstart="handleDragStart(event)"
         ondragover="handleDragOver(event)"
         ondrop="handleDrop(event)"
         ondragend="handleDragEnd(event)"
         ondragenter="handleDragEnter(event)"
         ondragleave="handleDragLeave(event)">

        <div class="flex items-center">
            <span class="drag-handle cursor-move text-gray-500 dark:text-gray-400 mr-4">â˜°</span>
            <span class="font-bold text-lg text-gray-800 dark:text-gray-200">#{{add $index 1}}</span>
        </div>

        <div class="flex-grow mx-4">
            <pre class="bg-gray-100 dark:bg-gray-800 p-2 rounded-md text-sm text-gray-800 dark:text-gray-200">{{marshal $rule}}</pre>
        </div>

        <div class="flex items-center space-x-2">
            <button class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded text-sm"
                    hx-get="/api/rules/form?index={{$index}}"
                    hx-target="body"
                    hx-swap="beforeend">
                Edit
            </button>
            <button class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded text-sm"
                    hx-post="/api/rules/delete?index={{$index}}"
                    hx-target="#rules-list"
                    hx-swap="innerHTML"
                    hx-confirm="Are you sure you want to delete this rule?">
                Delete
            </button>
        </div>
    </div>
    {{end}}
</div>

<style>
.dragging {
    opacity: 0.5;
    background-color: #e2e8f0;
}
.drag-over {
    border: 2px dashed #60a5fa;
}
</style>

<script>
let draggedElement = null;
let draggedIndex = null;

function handleDragStart(e) {
    draggedElement = e.target.closest('.rule-card');
    draggedIndex = parseInt(draggedElement.dataset.index);
    draggedElement.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', draggedIndex);
}

function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
}

function handleDragEnter(e) {
    const dropTarget = e.target.closest('.rule-card');
    if (dropTarget) {
        dropTarget.classList.add('drag-over');
    }
}

function handleDragLeave(e) {
    const dropTarget = e.target.closest('.rule-card');
    if (dropTarget) {
        dropTarget.classList.remove('drag-over');
    }
}

function handleDrop(e) {
    e.preventDefault();
    const dropTarget = e.target.closest('.rule-card');
    if (draggedElement && dropTarget && draggedElement !== dropTarget) {
        const dropIndex = parseInt(dropTarget.dataset.index);

        fetch('/api/rules/reorder', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `from=${draggedIndex}&to=${dropIndex}`
        })
        .then(response => response.ok ? response.text() : Promise.reject('Failed to reorder'))
        .then(html => {
            document.getElementById('rules-list').innerHTML = html;
        })
        .catch(error => {
            console.error('Error reordering rules:', error);
            alert('Failed to reorder rules. Please try again.');
        });
    }
    if (dropTarget) {
        dropTarget.classList.remove('drag-over');
    }
}

function handleDragEnd(e) {
    if(draggedElement) {
        draggedElement.classList.remove('dragging');
    }
    document.querySelectorAll('.rule-card').forEach(card => {
        card.classList.remove('drag-over');
    });
    draggedElement = null;
    draggedIndex = null;
}
</script>

{{else}}
<div class="text-center py-12">
    <p class="text-gray-500 dark:text-gray-400">No rules configured yet.</p>
    <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Click "Add Rule" to create your first routing rule.</p>
</div>
{{end}}
{{end}}
