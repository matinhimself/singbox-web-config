{{define "proxy-groups.html"}}
{{if .Groups}}
<div class="space-y-6">
    {{range .Groups}}
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md" data-group-type="{{.Type}}">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center cursor-pointer" onclick="toggleGroup(this)">
            <div class="flex items-center space-x-4">
                <span class="toggle-icon text-gray-500 dark:text-gray-400 transform transition-transform">â–¼</span>
                <div>
                    <h3 class="font-bold text-xl text-gray-900 dark:text-white">{{.Name}}</h3>
                    <span class="text-sm text-gray-500 dark:text-gray-400">{{.Type}}</span>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                {{if .Now}}
                <span class="px-2 py-1 text-xs font-mono font-semibold text-green-800 bg-green-100 dark:bg-green-900 dark:text-green-300 rounded-full">{{.Now}}</span>
                {{end}}
                {{if .CanSwitch}}
                <button class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded text-sm"
                        onclick="event.stopPropagation(); testGroupDelay('{{.Name}}', this)">
                    âš¡ Test
                </button>
                {{end}}
            </div>
        </div>

        <div class="proxy-nodes-container p-4 hidden">
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                {{range .Proxies}}
                <div class="relative p-3 rounded-lg border-2 transition-all
                    {{if .IsNow}} border-green-500 bg-green-50 dark:bg-green-900/20 {{else}} border-gray-300 dark:border-gray-600 hover:border-blue-500 dark:hover:border-blue-400 {{end}}
                    {{if $.CanSwitch}} cursor-pointer {{else}} cursor-not-allowed opacity-60 {{end}}"
                     hx-post="/api/proxies/switch"
                     hx-vals='{"group": "{{$.Name}}", "proxy": "{{.Name}}"}'
                     hx-trigger="{{if $.CanSwitch}}click{{else}}never{{end}}"
                     hx-target="#proxies-content"
                     hx-swap="innerHTML"
                     hx-indicator="#proxies-content">
                    <p class="font-semibold text-sm truncate text-center text-gray-800 dark:text-gray-200">{{.Name}}</p>
                    <p class="text-xs text-center
                        {{if and .Delay (lt .Delay 200)}} text-green-600 dark:text-green-400
                        {{else if and .Delay (lt .Delay 500)}} text-yellow-600 dark:text-yellow-400
                        {{else if .Delay}} text-red-600 dark:text-red-400
                        {{else}} text-gray-500 dark:text-gray-400 {{end}}">
                        {{if .Delay}}{{.Delay}}ms{{else}}-{{end}}
                    </p>
                </div>
                {{end}}
            </div>
        </div>
    </div>
    {{end}}
</div>
{{else}}
<div class="text-center py-16">
    <div class="text-6xl mb-4">ðŸ”Œ</div>
    <h3 class="text-2xl font-bold">No Proxy Groups Found</h3>
    <p class="text-gray-500 dark:text-gray-400 mt-2">Make sure your Clash API is configured correctly and running.</p>
</div>
{{end}}

<script>
function toggleGroup(header) {
    const card = header.closest('.bg-white');
    const container = card.querySelector('.proxy-nodes-container');
    const icon = card.querySelector('.toggle-icon');
    container.classList.toggle('hidden');
    icon.classList.toggle('rotate-[-90deg]');
}

function testGroupDelay(groupName, button) {
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span class="animate-spin inline-block w-4 h-4 border-2 border-white rounded-full border-t-transparent"></span>';

    fetch(`/api/proxies/group-delay-test?group=${encodeURIComponent(groupName)}`)
        .then(response => response.json())
        .then(data => {
            htmx.trigger('#proxies-content', 'load');
        })
        .catch(error => {
            console.error('Error testing delays:', error);
            button.innerHTML = 'Error';
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            }, 2000);
        });
}

document.body.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'proxies-content') {
        const container = document.querySelector('.space-y-6');
        if (!container) return;

        const groups = Array.from(container.children);
        groups.sort((a, b) => {
            const typeA = a.dataset.groupType;
            const typeB = b.dataset.groupType;
            if (typeA === 'Selector' && typeB !== 'Selector') return -1;
            if (typeA !== 'Selector' && typeB === 'Selector') return 1;
            const nameA = a.querySelector('h3').textContent;
            const nameB = b.querySelector('h3').textContent;
            return nameA.localeCompare(nameB);
        });
        groups.forEach(group => container.appendChild(group));
    }
});
</script>
{{end}}
